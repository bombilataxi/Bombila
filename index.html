import logging
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

TOKEN = '7976486101:AAGnlLZT_QYaD62AErfwvAtgjJLf3sKmLqY'  # –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π —Ç–æ–∫–µ–Ω

orders = {}        # client_id: –∑–∞–∫–∞–∑
active_chats = {}  # –≤–æ–¥–∏—Ç–µ–ª—å <-> –∫–ª–∏–µ–Ω—Ç
drivers = {}       # driver_id: {city, blocked, busy}
admin_ids = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–π Telegram ID

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# === /start ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üöï –í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏", web_app=WebAppInfo(url="https://your-webapp-url.com"))],
        [InlineKeyboardButton("üßë‚Äç‚úàÔ∏è –°—Ç–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º", callback_data="become_driver")]
    ]
    await update.message.reply_text("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Bombila!", reply_markup=InlineKeyboardMarkup(keyboard))

# === –ö–Ω–æ–ø–∫–∏ ===
async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "become_driver":
        cities = ["—Å–µ—É–ª", "–ø—É—Å–∞–Ω", "–∏–Ω—á–æ–Ω", "–∞–Ω—Å–∞–Ω", "–ø–∞—Ä–∞–Ω", "—á–æ–Ω–∞–Ω", "–∫–µ–Ω–¥–∂—É", "–∞–Ω—Å–æ–Ω–≥", "–ø–µ–Ω—Ç–µ–∫", "—Ç—ç–≥—É", "—á—Ö–æ–Ω–¥–∂—É", "–∫–≤–∞–Ω–¥–∂—É- –±", "–∞—Å–∞–Ω", "–æ—Å–∞–Ω"]
        city_buttons = [[InlineKeyboardButton(city, callback_data=f"reg_{city}")] for city in cities]
        await query.edit_message_text("–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:", reply_markup=InlineKeyboardMarkup(city_buttons))

    elif data.startswith("reg_"):
        city = data[4:]
        drivers[query.from_user.id] = {"city": city, "blocked": False, "busy": False}
        await query.edit_message_text(f"–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∫–∞–∫ –≤–æ–¥–∏—Ç–µ–ª—å –≤ –≥–æ—Ä–æ–¥–µ {city}.")

    elif data.startswith("take_"):
        client_id = int(data[5:])
        driver_id = query.from_user.id

        if drivers.get(driver_id, {}).get("busy"):
            await query.answer("–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑.", show_alert=True)
            return

        order = orders.get(client_id)
        if not order or order['status'] != 'active':
            await query.edit_message_text("–≠—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
            return

        orders[client_id]['status'] = 'taken'
        orders[client_id]['driver_id'] = driver_id
        drivers[driver_id]['busy'] = True
        active_chats[client_id] = driver_id
        active_chats[driver_id] = client_id

        await context.bot.send_message(client_id, "‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è!", reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑", callback_data=f"complete_{client_id}")]
        ]))
        await context.bot.send_message(driver_id, "‚úÖ –í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑. –í—ã –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É.")
        await query.edit_message_text("‚úÖ –í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑.")

    elif data.startswith("cancel_"):
        client_id = int(data[7:])
        driver_id = active_chats.get(client_id)
        if driver_id:
            await context.bot.send_message(driver_id, "‚ùå –ö–ª–∏–µ–Ω—Ç –æ—Ç–º–µ–Ω–∏–ª –∑–∞–∫–∞–∑.")
        orders.pop(client_id, None)
        active_chats.pop(client_id, None)
        active_chats.pop(driver_id, None)
        if driver_id in drivers:
            drivers[driver_id]['busy'] = False
        await query.message.edit_text("‚ùå –ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.")

    elif data.startswith("complete_"):
        client_id = int(data[9:])
        driver_id = active_chats.get(client_id)
        if driver_id:
            await context.bot.send_message(driver_id, "‚úÖ –ö–ª–∏–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª –∑–∞–∫–∞–∑.")
        orders.pop(client_id, None)
        active_chats.pop(client_id, None)
        active_chats.pop(driver_id, None)
        if driver_id in drivers:
            drivers[driver_id]['busy'] = False
        await query.message.edit_text("‚úÖ –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω.")

# === WebApp –∑–∞–∫–∞–∑—ã ===
async def handle_webapp(update: Update, context: ContextTypes.DEFAULT_TYPE):
    data = json.loads(update.message.web_app_data.data)
    user = update.effective_user
    city = data.get("city")
    if len([o for o in orders.values() if o.get("user_id") == user.id and o['status'] == 'active']) >= 2:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å —É–∂–µ 2 –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–∞. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –æ–¥–∏–Ω, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.")
        return

    orders[user.id] = {
        "user_id": user.id,
        "status": "active",
        "city": city,
        "pickup": data.get("pickup"),
        "destination": data.get("destination"),
        "price": data.get("price"),
        "location": data.get("location"),
        "driver_id": None
    }

    await update.message.reply_text("‚úÖ –í–∞—à –∑–∞–∫–∞–∑ —Ä–∞–∑–º–µ—â—ë–Ω!", reply_markup=InlineKeyboardMarkup([
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑", callback_data=f"cancel_{user.id}")]
    ]))

    msg = f"üöñ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑!\n–ì–æ—Ä–æ–¥: {city}\n–û—Ç–∫—É–¥–∞: {data.get('pickup')}\n–ö—É–¥–∞: {data.get('destination')}\n–¶–µ–Ω–∞: {data.get('price')}‚Ç©"
    if data.get("location"):
        loc = data["location"]
        msg += f"\n[–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è](https://maps.google.com/?q={loc['latitude']},{loc['longitude']})"

    keyboard = [[InlineKeyboardButton("‚úÖ –í–∑—è—Ç—å –∑–∞–∫–∞–∑", callback_data=f"take_{user.id}")]]
    for driver_id, info in drivers.items():
        if not info['blocked'] and not info['busy'] and info['city'].lower() == city.lower():
            await context.bot.send_message(driver_id, msg, parse_mode="Markdown", reply_markup=InlineKeyboardMarkup(keyboard))

# === –ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ===
async def forward(update: Update, context: ContextTypes.DEFAULT_TYPE):
    sender = update.effective_user.id
    if sender in active_chats:
        receiver = active_chats[sender]
        if update.message.location:
            await context.bot.send_location(receiver, update.message.location.latitude, update.message.location.longitude)
        elif update.message.text:
            await context.bot.send_message(receiver, update.message.text)

# === –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ===
async def admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in admin_ids:
        return await update.message.reply_text("‚õî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")

    txt = "\n".join([f"#{k} ‚Äî {v['pickup']} ‚Üí {v['destination']} ({v['city']})" for k, v in orders.items() if v['status'] == 'active']) or "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤."
    await update.message.reply_text("üì¶ –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã:\n" + txt)

    txt2 = "\n".join([f"{uid} ‚Äî {v['city']} {'üö´' if v['blocked'] else '‚úÖ'}" for uid, v in drivers.items()]) or "–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π."
    await update.message.reply_text("üöó –í–æ–¥–∏—Ç–µ–ª–∏:\n" + txt2)

# === MAIN ===
def main():
    app = ApplicationBuilder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("admin", admin))
    app.add_handler(CallbackQueryHandler(handle_buttons))
    app.add_handler(MessageHandler(filters.StatusUpdate.WEB_APP_DATA, handle_webapp))
    app.add_handler(MessageHandler(filters.LOCATION | filters.TEXT, forward))
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
